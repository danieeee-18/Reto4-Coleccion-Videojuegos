<!--
  P√°gina de Edici√≥n de Videojuego
  
  Formulario para editar los datos de un videojuego existente.
  Usa AJAX para enviar los cambios sin recargar la p√°gina.
-->

<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <!-- Breadcrumb de navegaci√≥n -->
      <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
          <li class="breadcrumb-item">
            <a href="/admin" class="text-primary text-decoration-none">
              <i class="bi bi-house-fill me-1"></i>
              Mi Colecci√≥n
            </a>
          </li>
          <li class="breadcrumb-item active text-secondary" aria-current="page">
            Editar Juego
          </li>
        </ol>
      </nav>
      
      <!-- Card principal -->
      <div class="card glass-effect shadow-lg fade-in">
        <!-- Header -->
        <div class="card-header py-4" style="background: var(--primary-gradient);">
          <h3 class="text-white mb-0 fw-bold">
            <i class="bi bi-pencil-square me-2"></i>
            Editar: <%= juego.titulo %>
          </h3>
        </div>
        
        <!-- Body con formulario -->
        <div class="card-body p-4 p-md-5">

          <!-- Mensaje de feedback AJAX -->
          <div id="editar-msg" class="alert mb-4" role="alert" style="display:none;"></div>

          <form id="form-editar" class="needs-validation" novalidate>
            <!-- ID oculto -->
            <input type="hidden" name="id" value="<%= juego.id %>">
            
            <!-- T√≠tulo -->
            <div class="mb-4">
              <label class="form-label fw-semibold">
                <i class="bi bi-controller me-1"></i>
                T√≠tulo del Juego *
              </label>
              <input 
                type="text" 
                name="titulo" 
                id="edit-titulo"
                class="form-control form-control-lg" 
                value="<%= juego.titulo %>" 
                placeholder="Ej: The Last of Us Part II"
                required
              >
              <div class="invalid-feedback">
                Por favor, introduce un t√≠tulo
              </div>
            </div>

            <!-- Plataforma y Estado -->
            <div class="row mb-4">
              <div class="col-md-6 mb-3 mb-md-0">
                <label class="form-label fw-semibold">
                  <i class="bi bi-display me-1"></i>
                  Plataforma *
                </label>
                <select name="plataforma" id="edit-plataforma" class="form-select form-select-lg" required>
                  <option value="PC" <%= juego.plataforma === 'PC' ? 'selected' : '' %>>PC</option>
                  <option value="PlayStation" <%= juego.plataforma === 'PlayStation' ? 'selected' : '' %>>PlayStation</option>
                  <option value="Xbox" <%= juego.plataforma === 'Xbox' ? 'selected' : '' %>>Xbox</option>
                  <option value="Nintendo" <%= juego.plataforma === 'Nintendo' ? 'selected' : '' %>>Nintendo</option>
                </select>
                <div class="invalid-feedback">
                  Selecciona una plataforma
                </div>
              </div>
              
              <div class="col-md-6">
                <label class="form-label fw-semibold">
                  <i class="bi bi-flag-fill me-1"></i>
                  Estado *
                </label>
                <select name="estado" id="edit-estado" class="form-select form-select-lg" required>
                  <option value="Pendiente" <%= juego.estado === 'Pendiente' ? 'selected' : '' %>>
                    ‚è≥ Pendiente
                  </option>
                  <option value="Jugando" <%= juego.estado === 'Jugando' ? 'selected' : '' %>>
                    üéÆ Jugando
                  </option>
                  <option value="Terminado" <%= juego.estado === 'Terminado' ? 'selected' : '' %>>
                    ‚úÖ Terminado
                  </option>
                </select>
                <div class="invalid-feedback">
                  Selecciona un estado
                </div>
              </div>
            </div>

            <!-- G√©nero -->
            <div class="mb-4">
              <label class="form-label fw-semibold">
                <i class="bi bi-tag-fill me-1"></i>
                G√©nero
              </label>
              <input 
                type="text" 
                name="genero" 
                id="edit-genero"
                class="form-control form-control-lg" 
                value="<%= juego.genero %>"
                placeholder="Ej: RPG, FPS, Aventura, Acci√≥n..."
              >
              <small class="text-secondary">
                <i class="bi bi-info-circle me-1"></i>
                Opcional - Ayuda a organizar mejor tu colecci√≥n
              </small>
            </div>

            <!-- Informaci√≥n adicional -->
            <div class="alert glass-effect border-0 mb-4">
              <div class="d-flex align-items-start">
                <i class="bi bi-calendar3 text-primary me-3" style="font-size: 1.5rem;"></i>
                <div>
                  <strong class="text-white">Fecha de creaci√≥n:</strong>
                  <p class="text-secondary mb-0">
                    <%= new Date(juego.fecha_creacion).toLocaleDateString('es-ES', { 
                      weekday: 'long', 
                      year: 'numeric', 
                      month: 'long', 
                      day: 'numeric' 
                    }) %>
                  </p>
                </div>
              </div>
            </div>

            <!-- Botones de acci√≥n -->
            <div class="d-flex justify-content-between gap-3 flex-wrap">
              <a href="/admin" class="btn btn-outline-light btn-lg px-4" id="btn-cancelar-editar">
                <i class="bi bi-x-lg me-2"></i>
                Cancelar
              </a>
              <button type="submit" class="btn btn-success btn-lg px-5 hover-lift" id="btn-guardar-editar">
                <i class="bi bi-check-lg me-2"></i>
                Guardar Cambios
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Estilos adicionales -->
<style>
  /* Mejorar breadcrumb */
  .breadcrumb {
    background: rgba(255, 255, 255, 0.05);
    padding: 0.75rem 1rem;
    border-radius: var(--border-radius-md);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }
  
  .breadcrumb-item + .breadcrumb-item::before {
    content: "‚Ä∫";
    color: var(--text-secondary);
  }
  
  /* Mejorar el aspecto de los selects */
  .form-select option {
    background: var(--bg-dark);
    color: var(--text-primary);
  }
  
  /* Animaci√≥n del bot√≥n de guardar */
  .btn-success:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0, 242, 254, 0.4);
  }
  
  /* Mensajes AJAX */
  #editar-msg.alert-success {
    background: rgba(0, 242, 254, 0.15);
    color: #00f2fe;
    border-left: 4px solid #00f2fe;
    display: block;
  }
  #editar-msg.alert-danger {
    background: rgba(255, 107, 107, 0.15);
    color: #ff6b6b;
    border-left: 4px solid #ff6b6b;
    display: block;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .card-body {
      padding: 2rem 1.5rem !important;
    }
    
    .btn-lg {
      padding: 0.75rem 2rem !important;
    }
  }
</style>

<!-- Script AJAX para el formulario de edici√≥n -->
<script>
(function() {
  'use strict';

  const form = document.getElementById('form-editar');
  const msgDiv = document.getElementById('editar-msg');
  const btnGuardar = document.getElementById('btn-guardar-editar');

  function mostrarMensaje(texto, tipo) {
    msgDiv.textContent = texto;
    msgDiv.className = 'alert alert-' + tipo;
    msgDiv.style.display = 'block';
    // Auto-ocultar mensajes de √©xito tras 3 s
    if (tipo === 'success') {
      setTimeout(() => { msgDiv.style.display = 'none'; }, 3000);
    }
  }

  form.addEventListener('submit', async function(e) {
    e.preventDefault();

    // Validaci√≥n HTML5
    if (!form.checkValidity()) {
      form.classList.add('was-validated');
      return;
    }

    btnGuardar.disabled = true;
    btnGuardar.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Guardando...';

    const datos = new FormData(form);
    const body = new URLSearchParams(datos);

    try {
      const respuesta = await fetch('/videojuegos/actualizar', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: body.toString()
      });

      const json = await respuesta.json();

      if (!respuesta.ok) {
        mostrarMensaje(json.error || 'Error al guardar los cambios', 'danger');
      } else {
        mostrarMensaje('‚úÖ Cambios guardados correctamente. Volviendo a la colecci√≥n...', 'success');
        setTimeout(() => { window.location.href = '/admin'; }, 1800);
      }
    } catch (err) {
      mostrarMensaje('Error de conexi√≥n. Int√©ntalo de nuevo.', 'danger');
    } finally {
      btnGuardar.disabled = false;
      btnGuardar.innerHTML = '<i class="bi bi-check-lg me-2"></i>Guardar Cambios';
    }
  });
})();
</script>