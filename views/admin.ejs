<!--
  Panel de Administraci√≥n - Vista principal
  
  Muestra la colecci√≥n de videojuegos del usuario con opciones para:
  - Filtrar por plataforma, g√©nero y estado
  - Ver solo favoritos (LocalStorage)
  - A√±adir nuevos videojuegos (AJAX)
  - Editar y eliminar videojuegos existentes
-->

<div class="container py-4">
  <!-- Encabezado con t√≠tulo y bot√≥n de a√±adir -->
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
    <h2 class="text-white fw-bold mb-0 fade-in" id="titulo-vista">
      <span style="font-size: 2rem; margin-right: 0.5rem;">üéÆ</span>
      Mi Colecci√≥n de Videojuegos
    </h2>
    <button class="btn btn-success hover-lift" type="button" data-bs-toggle="collapse" data-bs-target="#formNuevo" id="btn-nuevo-juego">
      <i class="bi bi-plus-lg me-2"></i>
      Nuevo Juego
    </button>
  </div>

  <!-- Alerta de feedback AJAX (oculta por defecto) -->
  <div id="ajax-feedback" class="alert mb-3" role="alert" style="display:none !important;"></div>

  <!-- Panel de filtros (se oculta en vista de favoritos) -->
  <div class="card mb-4 glass-effect slide-in" id="panel-filtros">
    <div class="card-body">
      <h5 class="text-white mb-3">
        <i class="bi bi-funnel-fill me-2"></i>
        Filtrar Colecci√≥n
      </h5>
      <form action="/admin" method="GET" class="row g-3 align-items-end" id="form-filtros">
        <!-- Filtro por Plataforma -->
        <div class="col-md-3 col-sm-6">
          <label class="form-label">
            <i class="bi bi-controller me-1"></i>
            Plataforma
          </label>
          <select name="plataforma" class="form-select">
            <option value="">Todas</option>
            <option value="PC" <%= filtros.plataforma == 'PC' ? 'selected' : '' %>>PC</option>
            <option value="PlayStation" <%= filtros.plataforma == 'PlayStation' ? 'selected' : '' %>>PlayStation</option>
            <option value="Xbox" <%= filtros.plataforma == 'Xbox' ? 'selected' : '' %>>Xbox</option>
            <option value="Nintendo" <%= filtros.plataforma == 'Nintendo' ? 'selected' : '' %>>Nintendo</option>
          </select>
        </div>
        
        <!-- Filtro por G√©nero -->
        <div class="col-md-3 col-sm-6">
          <label class="form-label">
            <i class="bi bi-tag-fill me-1"></i>
            G√©nero
          </label>
          <select name="genero" class="form-select">
            <option value="">Todos</option>
            <option value="RPG" <%= filtros.genero == 'RPG' ? 'selected' : '' %>>RPG</option>
            <option value="FPS" <%= filtros.genero == 'FPS' ? 'selected' : '' %>>FPS</option>
            <option value="Aventura" <%= filtros.genero == 'Aventura' ? 'selected' : '' %>>Aventura</option>
            <option value="Acci√≥n" <%= filtros.genero == 'Acci√≥n' ? 'selected' : '' %>>Acci√≥n</option>
            <option value="Estrategia" <%= filtros.genero == 'Estrategia' ? 'selected' : '' %>>Estrategia</option>
            <option value="Deportes" <%= filtros.genero == 'Deportes' ? 'selected' : '' %>>Deportes</option>
            <option value="Plataformas" <%= filtros.genero == 'Plataformas' ? 'selected' : '' %>>Plataformas</option>
            <option value="Puzzle" <%= filtros.genero == 'Puzzle' ? 'selected' : '' %>>Puzzle</option>
          </select>
        </div>
        
        <!-- Filtro por Estado -->
        <div class="col-md-3 col-sm-6">
          <label class="form-label">
            <i class="bi bi-flag-fill me-1"></i>
            Estado
          </label>
          <select name="estado" class="form-select">
            <option value="">Todos</option>
            <option value="Pendiente" <%= filtros.estado == 'Pendiente' ? 'selected' : '' %>>Pendiente</option>
            <option value="Jugando" <%= filtros.estado == 'Jugando' ? 'selected' : '' %>>Jugando</option>
            <option value="Terminado" <%= filtros.estado == 'Terminado' ? 'selected' : '' %>>Terminado</option>
          </select>
        </div>
        
        <!-- Botones de acci√≥n -->
        <div class="col-md-3 col-sm-6">
          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary flex-grow-1">
              <i class="bi bi-search me-1"></i>
              Filtrar
            </button>
            <a href="/admin" class="btn btn-outline-light" title="Limpiar filtros">
              <i class="bi bi-x-lg"></i>
            </a>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Formulario AJAX para a√±adir nuevo videojuego -->
  <div class="collapse mb-4" id="formNuevo">
    <div class="card glass-effect">
      <div class="card-body p-4">
        <h4 class="text-white mb-4">
          <i class="bi bi-plus-circle-fill me-2"></i>
          A√±adir Nuevo Videojuego
        </h4>
        <!-- Mensaje de error/√©xito dentro del formulario -->
        <div id="form-insertar-msg" class="alert mb-3" role="alert" style="display:none;"></div>

        <form id="form-insertar" class="row g-3" novalidate>
          <!-- T√≠tulo -->
          <div class="col-md-6">
            <label class="form-label">T√≠tulo del juego *</label>
            <input type="text" name="titulo" id="ins-titulo" class="form-control" placeholder="Ej: The Last of Us Part II" required>
          </div>
          
          <!-- Plataforma -->
          <div class="col-md-3">
            <label class="form-label">Plataforma *</label>
            <select name="plataforma" id="ins-plataforma" class="form-select" required>
              <option value="" disabled selected>Selecciona...</option>
              <option value="PC">PC</option>
              <option value="PlayStation">PlayStation</option>
              <option value="Xbox">Xbox</option>
              <option value="Nintendo">Nintendo</option>
            </select>
          </div>
          
          <!-- G√©nero -->
          <div class="col-md-3">
            <label class="form-label">G√©nero</label>
            <input type="text" name="genero" id="ins-genero" class="form-control" placeholder="Ej: RPG, FPS, Aventura">
          </div>
          
          <!-- Estado -->
          <div class="col-md-6">
            <label class="form-label">Estado *</label>
            <select name="estado" id="ins-estado" class="form-select" required>
              <option value="Pendiente">Pendiente</option>
              <option value="Jugando">Jugando</option>
              <option value="Terminado">Terminado</option>
            </select>
          </div>
          
          <!-- Botones -->
          <div class="col-md-6 d-flex justify-content-end gap-2 align-items-end">
            <button type="button" class="btn btn-outline-light" data-bs-toggle="collapse" data-bs-target="#formNuevo">
              Cancelar
            </button>
            <button type="submit" class="btn btn-success px-4" id="btn-guardar-insertar">
              <i class="bi bi-check-lg me-1"></i>
              Guardar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Mensaje de vista de favoritos vac√≠os (oculto por defecto) -->
  <div id="msg-sin-favoritos" style="display:none;" class="col-12 mb-4">
    <div class="card glass-effect text-center py-5 fade-in">
      <div class="card-body">
        <div style="font-size: 5rem; margin-bottom: 1rem;">‚≠ê</div>
        <h3 class="text-white mb-3">No tienes favoritos a√∫n</h3>
        <p class="text-secondary mb-4">
          Marca tus juegos favoritos pulsando el icono <i class="bi bi-star"></i> en cada tarjeta.
        </p>
        <button class="btn btn-primary btn-lg" id="btn-ver-todos-desde-fav">
          <i class="bi bi-grid-fill me-2"></i>
          Ver Todos los Juegos
        </button>
      </div>
    </div>
  </div>

  <!-- Grid de videojuegos -->
  <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" id="grid-juegos">
    <% if (videojuegos.length > 0) { %>
      <% videojuegos.forEach((juego, index) => { %>
        <div class="col fade-in juego-card" style="animation-delay: <%= index * 0.05 %>s;" data-id="<%= juego.id %>">
          <div class="card h-100 hover-lift">
            <!-- Header de la card con badges -->
            <div class="card-header d-flex justify-content-between align-items-center">
              <span class="badge bg-dark">
                <i class="bi bi-controller me-1"></i>
                <%= juego.plataforma %>
              </span>
              <div class="d-flex align-items-center gap-2">
                <% 
                  let colorEstado = 'bg-secondary';
                  let iconoEstado = 'bi-clock';
                  if(juego.estado === 'Jugando') {
                    colorEstado = 'bg-primary';
                    iconoEstado = 'bi-play-fill';
                  }
                  if(juego.estado === 'Terminado') {
                    colorEstado = 'bg-success';
                    iconoEstado = 'bi-check-circle-fill';
                  }
                  if(juego.estado === 'Pendiente') {
                    colorEstado = 'bg-warning text-dark';
                    iconoEstado = 'bi-hourglass-split';
                  }
                %>
                <span class="badge <%= colorEstado %>">
                  <i class="<%= iconoEstado %> me-1"></i>
                  <%= juego.estado %>
                </span>
                <!-- Bot√≥n de favorito -->
                <button
                  class="btn-fav"
                  data-id="<%= juego.id %>"
                  title="Marcar como favorito"
                  aria-label="Favorito"
                >
                  <i class="bi bi-star-fill"></i>
                </button>
              </div>
            </div>
            
            <!-- Cuerpo de la card -->
            <div class="card-body">
              <h5 class="card-title text-white fw-bold mb-2">
                <%= juego.titulo %>
              </h5>
              <p class="text-secondary small mb-2">
                <i class="bi bi-tag me-1"></i>
                <%= juego.genero || 'Sin g√©nero' %>
              </p>
              <p class="text-muted" style="font-size: 0.75rem;">
                <i class="bi bi-calendar3 me-1"></i>
                A√±adido: <%= new Date(juego.fecha_creacion).toLocaleDateString('es-ES') %>
              </p>
            </div>
            
            <!-- Footer con acciones -->
            <div class="card-footer d-flex justify-content-end gap-2">
              <a href="/videojuegos/editar/<%= juego.id %>" class="btn btn-sm btn-outline-light hover-lift">
                <i class="bi bi-pencil-fill"></i>
                <span class="d-none d-sm-inline ms-1">Editar</span>
              </a>
              
              <form action="/videojuegos/eliminar" method="POST" class="d-inline form-eliminar" data-titulo="<%= juego.titulo %>">
                <input type="hidden" name="id" value="<%= juego.id %>">
                <button type="submit" class="btn btn-sm btn-outline-danger hover-lift">
                  <i class="bi bi-trash-fill"></i>
                  <span class="d-none d-sm-inline ms-1">Borrar</span>
                </button>
              </form>
            </div>
          </div>
        </div>
      <% }) %>
    <% } else { %>
      <!-- Mensaje cuando no hay juegos -->
      <div class="col-12" id="msg-sin-juegos">
        <div class="card glass-effect text-center py-5 fade-in">
          <div class="card-body">
            <div style="font-size: 5rem; margin-bottom: 1rem;">üéÆ</div>
            <h3 class="text-white mb-3">No hay juegos en tu colecci√≥n</h3>
            <p class="text-secondary mb-4">
              <% if (filtros.plataforma || filtros.genero || filtros.estado) { %>
                No se encontraron juegos con los filtros seleccionados.
                <br>
                <a href="/admin" class="text-primary">Limpiar filtros</a>
              <% } else { %>
                ¬°Empieza a√±adiendo tu primer videojuego!
              <% } %>
            </p>
            <button class="btn btn-success btn-lg" type="button" data-bs-toggle="collapse" data-bs-target="#formNuevo">
              <i class="bi bi-plus-lg me-2"></i>
              A√±adir Primer Juego
            </button>
          </div>
        </div>
      </div>
    <% } %>
  </div>
  
  <!-- Estad√≠sticas r√°pidas -->
  <% if (videojuegos.length > 0) { %>
    <div class="mt-5 text-center" id="stats-juegos">
      <p class="text-secondary">
        <i class="bi bi-collection-fill me-2"></i>
        Total de juegos: <strong class="text-white" id="total-juegos"><%= videojuegos.length %></strong>
      </p>
    </div>
  <% } %>
</div>

<!-- Estilos adicionales para esta vista -->
<style>
  /* Mejorar el aspecto de los badges */
  .badge {
    font-size: 0.75rem;
    padding: 0.4rem 0.75rem;
  }
  
  /* Transici√≥n suave para el collapse */
  .collapsing {
    transition: height 0.35s ease;
  }

  /* ---- Bot√≥n de Favorito ---- */
  .btn-fav {
    background: none;
    border: none;
    cursor: pointer;
    padding: 0.2rem 0.4rem;
    border-radius: 6px;
    font-size: 1.1rem;
    color: rgba(255, 255, 255, 0.25);
    transition: color 0.2s, transform 0.2s;
    line-height: 1;
  }

  .btn-fav:hover {
    color: #ffd93d;
    transform: scale(1.2);
  }

  .btn-fav.favorito {
    color: #ffd93d;
    text-shadow: 0 0 8px rgba(255, 217, 61, 0.5);
  }

  /* Tarjeta favorita con borde dorado */
  .juego-card.es-favorito .card {
    border-color: rgba(255, 217, 61, 0.45) !important;
    box-shadow: 0 4px 20px rgba(255, 217, 61, 0.12);
  }

  /* Ocultaci√≥n suave de tarjetas */
  .juego-card.oculto {
    display: none !important;
  }

  /* Feedback AJAX */
  #ajax-feedback.visible {
    display: block !important;
  }
  #ajax-feedback.alert-success {
    background: rgba(0, 242, 254, 0.15);
    color: #00f2fe;
    border-left: 4px solid #00f2fe;
  }
  #ajax-feedback.alert-danger {
    background: rgba(255, 107, 107, 0.15);
    color: #ff6b6b;
    border-left: 4px solid #ff6b6b;
  }
  #form-insertar-msg.alert-success {
    background: rgba(0, 242, 254, 0.15);
    color: #00f2fe;
    border-left: 4px solid #00f2fe;
    display: block;
  }
  #form-insertar-msg.alert-danger {
    background: rgba(255, 107, 107, 0.15);
    color: #ff6b6b;
    border-left: 4px solid #ff6b6b;
    display: block;
  }
</style>